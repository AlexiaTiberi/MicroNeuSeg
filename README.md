# MicroNeuSeg

**MicroNeuSeg** is a Python-based pipeline designed to perform spatial analysis of microglia and neurons in mouse brain imaging data. The pipeline processes multiple image channelsâ€”Microglia (cx3cr1gfp or Iba1), PV, and NeuNâ€”and outputs the spatial coordinates of detected cells, enables region-of-interest masking, and allows extensive data filtering and visualization.

---

## ğŸ“‹ Data Setup and Folder Structure

The pipeline expects data organized as follows:

![alt text](image.png)
Each subfolder represents an animal and contains TIFF images named with the following format:

<animal_name>_<section_number>_<marker>.tif

Markers should explicitly be named: Iba1, PV, or NeuN, though the code is not case sensitive.

## ğŸš€ Features


The pipeline consists of sequentially numbered scripts to be executed in order:

1. **0_segment_single_folder.ipynb** *(Optional but recommended)*
   - Tests segmentation configuration on data from a single animal folder - use "animal1" folder path as defined in the Data Setup and Folder Structure chapter.
   - Useful for interactive parameter adjustments via `config.py`.
   - Start with this to broadly set up the segmentation

2. **1_segment_all_folders.ipynb / 1_segment_all.py**
   - Performs segmentation simultaneously across all animal folders - use "data" folder path as defined in the Data Setup and Folder Structure chapter.
   - Interactive visualization recommended via notebook version (`.ipynb`).

3. **2_masking.ipynb**
   - Allows manual masking to define a specific region of interest (ROIs).
   - This is mandatory as this pipeline was constructed to analyze a mouse cortex, so there is a need to cut away empty parts of the images and also subcortical stuff... see the data folder for some sample images

4. **3_filter_all_folders.ipynb** 
   - Uses the mask drawn in 2 to filter the data coordinates from the segmentation

5. **4_extract_data.ipynb** 
   - This is the code that does the "data analysis"
   - It will output an excel file per section analyzed of all mice
### Parameters Extracted (per section)

Each `.xlsx` file generated by the analysis includes the following parameters for the masked region of each brain section:

| Parameter | Description |
|----------|-------------|
| **Area** | Area of the manually defined region of interest (ROI) in mmÂ². |
| **Microglia_Density** | Number of Iba1âº microglia per mmÂ² within the ROI. |
| **PV_Density** | Number of PVâº interneurons per mmÂ² within the ROI. |
| **NeuN+PV-_Density** | Density of NeuNâº PVâ» cells. |
| **NeuN_Density** | Total number of NeuNâº neurons per mmÂ². |
| **Perc_Microglia_associated_PV_Observed** | Percentage of PVâº cells with at least one microglia within the specified threshold distance (e.g., 15 px). |
| **Perc_PV_associated_Microglia_Synthetic** | Same as above, but using a synthetic distribution of microglia to test for spatial association. |
| **Average_Nearest_Distance_PV_to_microglia_Observed** | Mean distance (in Âµm) between each PVâº cell and its closest microglia. |
| **Average_Nearest_Distance_PV_to_microglia_Synthetic** | Mean distance (in Âµm) for the same analysis using synthetic microglia coordinates. |
| **Perc_Microglia_associated_NeuNPV_Observed** | Percentage of NeuNâºPVâ» cells with at least one microglia within threshold. |
| **Perc_Microglia_associated_NeuNPV_Synthetic** | Same as above, with synthetic microglia coordinates. |
| **Average_Nearest_Distance_NeuNPV_to_microglia_Observed** | Mean distance (in Âµm) between each NeuNâºPVâ» cell and its closest microglia. |
| **Average_Nearest_Distance_NeuNPV_to_microglia_Syntetic** | Mean distance (in Âµm) for the same using bootstrapped coordinates. |
| **Perc_PV_associated_Microglia** | Percentage of Iba1âº cells that are close (within threshold) to at least one PVâº cell. |
| **Average_Nearest_Distance_microglia_to_PV** | Mean distance (in Âµm) between Iba1âº cells and their closest PVâº cell. |
| **Perc_NeuNPV_associated_Microglia** | Percentage of Iba1âº cells close to at least one NeuNâºPVâ» cell. |
| **Average_Nearest_Distance_microglia_to_NeuNPV** | Mean distance (in Âµm) between Iba1âº cells and their closest NeuNâºPVâ» cell. |
| **E_I_ratio** | This is a derivative parameters which is (Perc_NeuNPV_associated_Microglia-Perc_PV_associated_Microglia)/(Perc_NeuNPV_associated_Microglia+Perc_PV_associated_Microglia) |

---

## âš™ï¸ Installation & Requirements
**My personal suggestions is to first install stardist and tensorflow using their installation guidelines, the rest you can easily add later when you run the script**

### Prerequisites

- Stardist and TensorFlow environment ([installation guide](https://github.com/stardist/stardist))

### Other Python Libraries

- `scikit-image`
- `opencv-python`
- `pandas`
- `numpy`
- `matplotlib`
- `seaborn`

## ğŸ“„ License
This project is licensed under the MIT License â€“ see the LICENSE file for details.
